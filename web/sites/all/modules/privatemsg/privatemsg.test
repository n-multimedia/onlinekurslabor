<?php
/**
 * @file
 * Test file for privatemsg.module
 *
 */

/**
 * Base class for Privatemsg tests.
 */
class PrivatemsgBaseTestCase extends DrupalWebTestCase {
  /**
   * Use testing profile.
   */
  protected $profile = 'testing';
}

class PrivatemsgTestCase extends PrivatemsgBaseTestCase {
  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array
    (
      // 'name' should start with what is being tested (menu item) followed by what about it
      // is being tested (creation/deletion).
      'name' => t('Privatemsg functionality.'),
      // 'description' should be one or more complete sentences that provide more details on what
      // exactly is being tested.
      'description' => t('Test sending, receiving, listing, deleting messages and other features.'),
      // 'group' should be a logical grouping of test cases, like a category.  In most cases, that
      // is the module the test case is for.
      'group' => t('Privatemsg'),
    );
  }

  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('privatemsg');


    // Create the full html format.
    $full_html_format = array(
      'format' => 'full_html',
      'name' => 'Full HTML',
      'weight' => 1,
      'filters' => array(
        // URL filter.
        'filter_url' => array(
          'weight' => 0,
          'status' => 1,
        ),
        // Line break filter.
        'filter_autop' => array(
          'weight' => 1,
          'status' => 1,
        ),
        // HTML corrector filter.
        'filter_htmlcorrector' => array(
          'weight' => 10,
          'status' => 1,
        ),
      ),
    );
    $full_html_format = (object) $full_html_format;
    filter_format_save($full_html_format);
    // Refresh permissions.
    $this->checkPermissions(array(), TRUE);
  }

  /**
   * Test user access to /messages
   * Create user with no 'read privatemsg' permission. Try to access mailbox and see if it gives access denied error
   * Create user with 'read privatemsg' permission. Try to access mailbox and see if it gives allows access
   */
  function testPrivatemsgReadPrivatemsgPermission() {
    $user_no_read_msg = $this->drupalCreateUser(); // set up user with default permissions (meaning: no read privatemsg permission
    $author     = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient  = $this->drupalCreateUser(array('read privatemsg'));
    $no_recipient  = $this->drupalCreateUser(array('read privatemsg'));


    $subject = $this->randomName(20);
    $body = $this->randomName(50);

    $response = privatemsg_new_thread(array($recipient), $subject, $body, array('author' => $author));

    $this->drupalLogin($user_no_read_msg);
    $this->drupalGet('messages');
    $this->assertResponse(403, t('HTTP Response 403: Access to mailbox was blocked to user without "<em>read privatemsg</em>" permission'));

    $this->drupalLogin($no_recipient);
    $this->drupalGet('messages');
    $this->assertResponse(200, t('HTTP Response 200: Access to mailbox was authorized to user with "<em>read privatemsg</em>" permission'));

    $this->drupalGet('messages/view/' . $response['message']->thread_id);
    $this->assertResponse(403, t('HTTP Response 403: Access to thread is blocked for non-recipients.'));

    $this->drupalLogin($recipient);
    $this->drupalGet('messages/view/' . $response['message']->thread_id);
    $this->assertText($subject, t('Access to thread for recipient allowed.'));

    $this->drupalGet('messages/view/' . $response['message']->thread_id + 1);
    $this->assertResponse(404, t('Non-existing thread lead to HTTP Response 404.'));

  }
  /**
   * Test user access to /messages/new
   * Create user with no 'write privatemsg' permission. Try to access Write New Message page and see if it gives access denied error
   * Create user with 'write privatemsg' permission. Try to access Write New Message page and see if it gives allows access
   */
  function testPrivatemsgWritePrivatemsgPermission() {
    $user_no_write_msg = $this->drupalCreateUser(); // set up user with default permissions (meaning: no read privatemsg permission
    $this->drupalLogin($user_no_write_msg);
    $this->drupalGet('messages/new');
    $this->assertResponse(403, t('HTTP Response 403: Access to Write New Message page was blocked to user without "<em>write privatemsg</em>" permission'));

    $user_write_msg = $this->drupalCreateUser(array('write privatemsg')); // set up user with write privatemsg permissions
    $this->drupalLogin($user_write_msg);
    $this->drupalGet('messages/new');
    $this->assertResponse(200, t('HTTP Response 200: Access to Write New Message page was authorized to user with "<em>write privatemsg</em>" permission'));
  }

  function testPaging() {
    $author     = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient  = $this->drupalCreateUser(array('read privatemsg'));

    // Set lower values so that we don't need to generate 100's of messages.
    variable_set('privatemsg_view_default_amount', 5);
    variable_set('privatemsg_view_max_amount', 10);

    $subject_single = $this->randomName(20);
    $subject = $this->randomName(20);
    $bodies = array();
    for ($i = 0; $i < 24; $i++) {
      $bodies[$i] = $this->randomName(100);
    }
    privatemsg_new_thread(array($recipient), $subject_single, $bodies[23], array('author' => $author));
    $thread = privatemsg_new_thread(array($recipient), $subject, $bodies[0], array('author' => $author));
    for ($i = 1; $i < 23; $i++) {
      privatemsg_reply($thread['message']->thread_id, $bodies[$i], array('author' => $author));
    }

    $this->drupalLogin($recipient);
    $this->drupalGet('messages');
    $this->clickLink($subject_single);

    $this->assertNoText(t('Displaying messages 1 - 1 of 1'), t('Pager is displayed'));
    $this->assertNoText(t('&gt;&gt;'), t('Newer messages link not displayed.'));
    $this->assertNoText(t('&lt;&lt;'), t('Older messages link not displayed.'));

    $this->drupalGet('messages');
    $this->clickLink($subject);

    // Verify that only the last 10 messages are displayed.
    $this->assertText(t('&lt;&lt; Displaying messages 14 - 23 of 23'), t('Pager is displayed'));
    $this->assertNoText($bodies[0], t('First message is not displayed.'));
    $this->assertNoText($bodies[12], t('Hidden message is not displayed.'));
    $this->assertText($bodies[13], t('Message is displayed.'));
    $this->assertText($bodies[22], t('Message is displayed.'));
    $this->assertNoText(t('&gt;&gt;'), t('Newer messages link not displayed.'));

    variable_set('privatemsg_view_use_max_as_default', TRUE);
    $this->drupalGet('messages');
    $this->clickLink($subject);

    // Now with separate default value.
    // Verify that only the last 5 messages are displayed.
    $this->assertText(t('&lt;&lt; Displaying messages 19 - 23 of 23'), t('Pager is displayed'));
    $this->assertNoText($bodies[0], t('First message is not displayed.'));
    $this->assertNoText($bodies[17], t('Hidden message is not displayed.'));
    $this->assertText($bodies[18], t('Message is displayed.'));
    $this->assertText($bodies[22], t('Message is displayed.'));
    $this->assertNoText(t('>>'), t('Newer messages link not displayed.'));

    // Load older messages and verify again.
    $this->clickLink(t('<<'));
    $this->assertText(t('&lt;&lt; Displaying messages 9 - 18 of 23 &gt;&gt;'), t('Pager is displayed'));
    $this->assertNoText($bodies[0], t('First message is not displayed.'));
    $this->assertNoText($bodies[7], t('Hidden message is not displayed.'));
    $this->assertText($bodies[8], t('Message is displayed.'));
    $this->assertText($bodies[17], t('Message is displayed.'));
    $this->assertNoText($bodies[22], t('Hidden message is not displayed.'));

    // Load older messages and verify again.
    $this->clickLink(t('<<'));
    $this->assertText(t('Displaying messages 1 - 8 of 23 &gt;&gt;'), t('Pager is displayed'));
    $this->assertText($bodies[0], t('Message is displayed.'));
    $this->assertText($bodies[7], t('Message is displayed.'));
    $this->assertNoText($bodies[9], t('Hidden message is not displayed.'));
    $this->assertNoText(t('&lt;&lt;'), t('Older messages link not displayed.'));

    // Going back should follow the same order.
    $this->clickLink(t('>>'));
    $this->assertText(t('&lt;&lt; Displaying messages 9 - 18 of 23 &gt;&gt;'), t('Pager is displayed'));
    $this->assertNoText($bodies[0], t('First message is not displayed.'));
    $this->assertNoText($bodies[7], t('Hidden message is not displayed.'));
    $this->assertText($bodies[8], t('Message is displayed.'));
    $this->assertText($bodies[17], t('Message is displayed.'));
    $this->assertNoText($bodies[22], t('Hidden message is not displayed.'));

    variable_set('privatemsg_view_max_amount', PRIVATEMSG_UNLIMITED);
    $this->drupalGet('messages');
    $this->clickLink($subject);

    // Now with separate default value.
    // Verify that only the last 5 messages are displayed.
    $this->assertText(t('&lt;&lt; Displaying messages 19 - 23 of 23'), t('Pager is displayed'));
    $this->assertNoText($bodies[0], t('First message is not displayed.'));
    $this->assertNoText($bodies[17], t('Hidden message is not displayed.'));
    $this->assertText($bodies[18], t('Message is displayed.'));
    $this->assertText($bodies[22], t('Message is displayed.'));
    $this->assertNoText(t('&gt;&gt;'), t('Newer messages link not displayed.'));

    // Load older messages and verify again.
    $this->clickLink(t('<<'));
    $this->assertNoText(t('Displaying messages 1 - 23 of 23'), t('Pager is displayed'));
    $this->assertText($bodies[0], t('Message is displayed.'));
    $this->assertText($bodies[22], t('Message is displayed.'));
    $this->assertNoText(t('&gt;&gt;'), t('Newer messages link not displayed.'));
    $this->assertNoText(t('&lt;&lt;'), t('Older messages link not displayed.'));

    // Check with max_amount = UNLIMITED and different default amount disabled.
    variable_set('privatemsg_view_use_max_as_default', FALSE);

    $this->drupalGet('messages');
    $this->clickLink($subject);
    $this->assertNoText(t('Displaying messages 1 - 23 of 23'), t('Pager is displayed'));
    $this->assertText($bodies[0], t('Message is displayed.'));
    $this->assertText($bodies[22], t('Message is displayed.'));
    $this->assertNoText(t('&gt;&gt;'), t('Newer messages link not displayed.'));
    $this->assertNoText(t('&lt;&lt;'), t('Older messages link not displayed.'));
  }

  /**
   * Test sending message from the /messages/new page between two people
   */
  function testWriteReplyPrivatemsg() {
    // Create an author and two recipients.
    $author     = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg', 'select text format for privatemsg', filter_permission_name(filter_format_load('full_html'))));
    $recipient  = $this->drupalCreateUser(array('read privatemsg'));
    $recipient2  = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    // Set up a user with "read/write privatemsg" permissions.
    $blocked_recipient = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    // Block this recipient to test users who cancelled their accounts.
    user_save($blocked_recipient, array('status' => 0));

    // Login author and go to new message form.
    $this->drupalLogin($author);
    $this->drupalGet('messages/new');

    // Prepare edit arrays, single recipient with [user].
    $edit = array(
      'recipient'   => $recipient->name . ' [user]',
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // Two recipients.
    $edit2 = array(
      'recipient'   => $recipient->name . ', ' . $recipient2->name,
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // No recipients.
    $editnone = array(
      'recipient'   => '',
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // Invalid recipient.
    $editinvalid = array(
      'recipient'   => $this->randomName(5),
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // Blocked recipient.
    $editrecipientblocked = array(
      'recipient'   => $blocked_recipient->name,
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // Message for which the author will be blocked later.
    $editauthorblocked = array(
      'recipient'   => $recipient2->name,
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );
    // Empty body.
    $editnobody = array(
      'recipient'   => $recipient->name,
      'subject'     => $this->randomName(20),
      'body[value]' => '',
    );
    // Empty subject.
    $editnosubject = array(
      'recipient'   => $recipient->name,
      'subject'     => '',
      'body[value]' => $this->randomName(100),
    );
    // Empty subject and body.
    $editempty = array(
      'recipient'   => $recipient->name,
      'subject'     => '',
      'body[value]' => '',
    );
    // Empty subject and body.
    $editonlyspace = array(
      'recipient'   => $recipient2->name,
      'subject'     => ' ',
      'body[value]' => $this->randomName(10),
    );
    // Invalid and valid recipient
    $editmixed = array(
      'recipient'   => ($invalidmixed = $this->randomName(5)) . ', ' . $recipient->name,
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100),
    );

    // message with a bold part, not allowed with default format
    $editformatted = array(
      'recipient'   => $recipient2->name,
      'subject'     => $this->randomName(20),
      'body[value]' => $this->randomName(100) . '<b>formatted message #1</b>',
      'body[format]' => 'full_html',
    );

    // Submit the messages.
    $this->drupalPost('messages/new', $edit, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient->name)), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $edit2, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => implode(', ', array($recipient->name, $recipient2->name)))), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $editnone, t('Send message'));
    $this->assertText(t('To field is required.'), 'Message was not sent.');

    $this->drupalPost('messages/new', $editinvalid, t('Send message'));
    $this->assertText(t('You must include at least one valid recipient.'), 'Message was not sent.');
    $this->assertText(t('The following users will not receive this private message: @recipients', array('@recipients' => $editinvalid['recipient'])), 'Message about non-existing user displayed.');

    $this->drupalPost('messages/new', $editrecipientblocked, t('Send message'));
    $this->assertText(t('@recipients has disabled his or her account.', array('@recipients' => $blocked_recipient->name)), 'Message about blocked user displayed.');
    $this->assertText(t('You are not allowed to send this message because all recipients are blocked.'), 'Message was not sent.');

    // We will block the author later to test whether the reply form appears.
    $this->drupalPost('messages/new', $editauthorblocked, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient2->name)), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $editnobody, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient->name)), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $editnosubject, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient->name)), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $editempty, t('Send message'));
    $this->assertText(t('You must include a subject line with your message.'), 'Empty subject message displayed.');

    $this->drupalPost('messages/new', $editonlyspace, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient2->name)), 'Message sent confirmation displayed.');

    $this->drupalPost('messages/new', $editmixed, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient->name)), 'Message sent confirmation displayed.');
    $this->assertText(t('The following users will not receive this private message: @recipients', array('@recipients' => $invalidmixed)), 'Message about non-existing user displayed.');

    $this->drupalPost('messages/new', $editformatted, t('Send message'));
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient2->name)), 'Message sent confirmation displayed.');

    // Login as recipient2 and try to write some replies.
    $this->drupalLogin($recipient2);
    $this->drupalGet('messages');

    // Check that the message with only a space in the subject uses the body
    // as subject.
    $this->clickLink($editonlyspace['body[value]']);
    $this->drupalGet('messages');

    $this->assertNoText($edit['subject'], 'Message sent to other recipient not found.');
    $this->assertText($edit2['subject'], 'Sent message subject found.');
    $this->clickLink($edit2['subject']);

    $this->assertText($edit2['body[value]'], 'Found message body.');

    // Prepare replies.
    $reply = array(
      'body[value]' => $this->randomName(100),
    );
    // Empty body.
    $replyempty = array(
      'body[value]' => '',
    );

    $this->drupalPost(NULL, $reply, t('Send message'));
    $this->assertText($reply['body[value]'], 'New message body displayed.');

    $this->drupalPost(NULL, $replyempty, t('Send message'));
    $this->assertText(t('You must include a message in your reply.'));

    // reply with a bold part, not allowed with default format
    $replyformatted = array(
      'body[value]' => $this->randomName(100) . '<b>formatted message #2</b>',
    );
    $this->drupalGet('messages');
    $this->clickLink($editformatted['subject']);
    $this->assertRaw($editformatted['body[value]'], 'Found formatted message body.');

    $this->drupalPost(NULL, $replyformatted, t('Send message'));
    $this->assertNoRaw($replyformatted['body[value]'], 'Did not find formatted reply body.');
    $this->assertText(check_plain($replyformatted['body[value]']), 'New reply body displayed.');

    // Login using recipient and try to read the message by going to inbox first.
    $this->drupalLogin($recipient);
    $this->drupalGet('messages');

    // Assert if we see the subject of the messages.
    $this->assertText($edit['subject'], 'Sent message subject found.');
    $this->assertText($edit2['subject'], 'Sent message subject found.');
    $this->assertText($editnobody['subject'], 'Sent message subject found.');
    $this->assertText(trim(truncate_utf8(strip_tags($editnosubject['body[value]']), 50, TRUE, TRUE)), 'Sent message subject found.');
    $this->assertText($editmixed['subject'], 'Sent message subject found.');

    // Assert that we don't see those that were invalid.
    $this->assertNoText($editnone['subject'], 'Invalid message subject not found.');
    $this->assertNoText($editinvalid['subject'], 'Invalid message subject not found.');

    // Navigate into the message.
    $this->clickLink($edit['subject']);
    // Confirm that we can read the message that was sent.
    $this->assertText($edit['body[value]'], 'Found message body.');
    $this->assertNoText(t('Reply to thread:'), 'Reply form is not displayed.');

    // Verify that the participants information is correct.
    $this->assertText(t('Between you and @author', array('@author' => $author->name)));

    // Navigate into the message.
    $this->drupalGet('messages');
    $this->clickLink($edit2['subject']);
    // Confirm that we can read the message that was sent.
    $this->assertText($edit2['body[value]'], 'Found message body.');
    // Confirm that we can read the reply that was sent.
    $this->assertText($reply['body[value]'], 'Found reply body.');

    // Block the author.
    user_save($author, array('status' => 0));
    $this->drupalLogin($recipient2);
    // Navigate into the message.
    $this->drupalGet('messages');
    $this->clickLink($editauthorblocked['subject']);
    // Confirm that the reply form is not shown.
    $this->assertNoText(t('Reply'), 'Reply form is not displayed.');
    $this->assertText(t('You can not reply to this conversation because all recipients are blocked.'));
  }

  /**
   * Test functionality around disabling private messaging.
   */
  function testDisablePrivatemsg() {
    $admin_user = $this->drupalCreateUser(array('administer permissions'));
    $enableduser = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg')); // set up user with read/write privatemsg permissions
    $enableduser2 = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg')); // set up user with read/write privatemsg permissions
    $disableduser = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg', 'allow disabling privatemsg')); // set up user with read/write privatemsg permissions

    // Create a message between the users that we can use to test
    $return = privatemsg_new_thread(array($disableduser), $this->randomName(20), $this->randomName(100), array('author' => $enableduser));
    $mid = $return['message']->thread_id;

    $this->drupalLogin($disableduser);
    // Now disable $disabledUser.
    $this->drupalGet('user/' . $disableduser->uid . '/edit');
    $edit['pm_enable'] = FALSE;
    $this->drupalPost('user/' . $disableduser->uid . '/edit', $edit, t('Save'));

    // Verify that disableduser can list messages.
    $this->drupalGet('messages');
    $this->assertResponse(200, t('HTTP Response 200: Access to reading messages page is allowed.'));

    // Verify that $disableduser can read messages but there is not reply form
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertResponse(200, t('HTTP Response 200: Access to message thread page is allowed.'));
    $this->assertNoText(t('Reply to thread'), 'No reply form shown.');

    // Verify that $disableduser cannot send a new message.
    $this->drupalGet('messages/new');
    $this->assertResponse(403, t('HTTP Response 403: Access to Write New Message page was blocked to user with private messaging disabled'));

    // Use a newly loaded user object to test the API calls.
    $disableduser_loaded = user_load($disableduser->uid, TRUE);

    // Check that $disableduser cannot submit a reply
    $result = privatemsg_reply($return['message']->thread_id, $this->randomName(100), array('author' => $disableduser_loaded));

    $this->assertFalse($result['success'], 'Message reply was not sent.');

    // Log in as $enableduser and try to send to $disabled user.
    // Make sure that a message to multiple recipients still works if one is
    // disabled.
    $message = array(
      'recipient'   => $disableduser->name,
      'subject'     => $this->randomName(20),
      'body[value]'        => $this->randomName(100),
    );
    $this->drupalLogin($enableduser);
    $this->drupalPost('messages/new', $message, t('Send message'));
    $this->assertText(t('You are not allowed to send this message because all recipients are blocked.'));

    // Make sure that a message to multiple recipients still works if one is
    // disabled.
    $messagemultiple = array(
      'recipient'   => $enableduser2->name . ', ' . $disableduser->name,
      'subject'     => $this->randomName(20),
      'body[value]'        => $this->randomName(100),
    );
    $this->drupalPost('messages/new', $messagemultiple, t('Send message'));
    $this->assertText(t('@recipient has disabled private message receiving.', array('@recipient' => $disableduser->name)), 'Message about user with disabled private messaging.');
    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $enableduser2->name)), 'Message sent confirmation displayed.');

    // Remove the permission to disable privatemsg.
    $this->drupalLogin($admin_user);
    // 6 is the rid of the custom $disableduser role.
    $edit = array('6[allow disabling privatemsg]' => FALSE);
    $this->drupalPost('admin/people/permissions', $edit, t('Save permissions'));

    // Make sure that the option is not visible anymore.
    $this->drupalLogin($disableduser);
    $this->drupalGet('user/' . $disableduser->uid . '/edit');
    $this->assertNoText(t('Enable Private Messaging'), t('Disable privatemsg setting not displayed'));

    // Verify that the user is now allowed to write messages again.
    $this->drupalGet('messages/new');
    $this->assertNoText(t('You are not authorized to access this page.'), t('Access denied page is not displayed.'));
    $this->assertText(t('Write new message'), t('Write message form is displayed.'));
  }

  /**
   * Test correct handling of read all permissions.
   */
  function testReadAllPermission() {
    $author    = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $admin     = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'read all private messages'));

    // Create new message.
    $edit = array(
      'recipient'   => $recipient->name,
      'subject'     => $this->randomName(20),
      'body[value]'        => $this->randomName(100),
    );
    $this->drupalLogin($author);
    $this->drupalPost('messages/new', $edit, t('Send message'));

    $this->assertText(t('A message has been sent to @recipients.', array('@recipients' => $recipient->name)), t('Message sent confirmation displayed'));

    $this->drupalLogin($admin);
    $this->drupalGet('messages/view/1');

    $this->assertText(t('This conversation is being viewed with escalated privileges and may not be the same as shown to normal users.'), t('Notice about read all mode displayed.'));

    // Send a first response.
    $admin_edit = array(
      'body[value]'        => $this->randomName(100),
    );
    $this->drupalPost('messages/view/1', $admin_edit, t('Send message'));

    // Make sure that the notice is not displayed anymore.
    // @tod: Commented out because this does not work as expected.
    $this->assertNoText(t('This conversation is being viewed with escalated privileges and may not be the same as shown to normal users.'), t('Notice about read all mode not displayed.'));

    // Make sure that both the existing message body and the new one are displayed.
    $this->assertText($edit['body[value]'], t('First message body displayed.'));
    $this->assertText($admin_edit['body[value]'], t('New message body displayed.'));

    $admin_recipient_count = db_query("SELECT COUNT(*) FROM {pm_index} WHERE recipient = :recipient AND thread_id = :thread_id", array(
      ':recipient' => $admin->uid,
      ':thread_id' => 1,
    ))->fetchField();
    $this->assertEqual($admin_recipient_count, 2, t('Admin is listed as recipient for every message once.'));


    // Send a second response.
    $admin_edit2 = array(
      'body[value]' => $this->randomName(100),
    );
    $this->drupalPost('messages/view/1', $admin_edit2, t('Send message'));

    // Make sure that both the existing message body and the new one are displayed.
    $this->assertText($edit['body[value]'], t('First message body displayed.'));
    $this->assertText($admin_edit['body[value]'], t('Second response body displayed.'));
    $this->assertText($admin_edit2['body[value]'], t('Third message body displayed.'));

    $admin_recipient_count = db_query("SELECT COUNT(*) FROM {pm_index} WHERE recipient = :recipient AND thread_id = :thread_id", array(
      ':recipient' => $admin->uid,
      ':thread_id' => 1,
    ))->fetchField();
    $this->assertEqual($admin_recipient_count, 3, t('Admin is listed as recipient for every message once.'));

  }

  /**
   * Tests for the flush feature
   */
  function testPrivatemsgFlush() {
    $author = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));

    // Send 10 messages.
    for ($i = 0; $i < 10; $i++) {
      privatemsg_new_thread(array($recipient), 'Message #' . $i, 'This is the body', array('author' => $author));
    }

    // Delete message 1, 3, 4, 6, 9 for author.
    foreach (array(1, 3, 4, 6, 9) as $pmid) {
      privatemsg_message_change_delete($pmid, TRUE, $author);
    }

    // Delete message 1, 2, 4, 6, 8 for recipient.
    foreach (array(1, 3, 4, 6, 9) as $pmid) {
      privatemsg_message_change_delete($pmid, TRUE, $recipient);
    }

    // Now, mid 1, 4 and 6 have been deleted by both.

    // Flush configuration, enable, delay is default, 30 days
    variable_set('privatemsg_flush_enabled', TRUE);

    // Set back the deleted timestamp 35 days back of mid 4.
    db_update('pm_index')
      ->fields(array('deleted' => REQUEST_TIME - 35 * 86400))
      ->condition('mid', 4)
      ->execute();
    // Set back the deleted timestamp of mid 6, but only 20 days back.
    db_update('pm_index')
      ->fields(array('deleted' => REQUEST_TIME - 20 * 86400))
      ->condition('mid', 6)
      ->execute();

    // Run flush.
    privatemsg_cron();

    // Check if the undeleted messages are still there.
    foreach (array(2, 3, 5, 7, 8, 9, 10) as $pmid) {
      $message = privatemsg_message_load($pmid, $author);
      $this->assertTrue(!empty($message), t('Undeleted message #%id is still in the system', array('%id' => $pmid)));
    }

    // Check if the "recently" deleted  messages are still there.
    foreach (array(1, 6) as $pmid) {
      $message = privatemsg_message_load($pmid, $author);
      $this->assertTrue(!empty($message), t('Deleted message #%id is still in the system', array('%id' => $pmid)));
    }

    // Mid 4 should have been flushed.
    $message = privatemsg_message_load(4, $author);
    $this->assertTrue(empty($message), t('Message #4 has been flushed'));
  }

  function testDelete() {
    // Create users.
    $author = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'delete privatemsg'));
    $recipient = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'delete privatemsg'));
    $recipient2 = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'cancel account'));
    $admin = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'delete privatemsg', 'read all private messages'));
    $dummy = $this->drupalCreateUser(array('cancel account'));

    // Create texts.
    $subject = $this->randomName(20);
    $body1 = $this->randomName(100);
    $body2 = $this->randomName(100);

    // Create message and response.
    $return = privatemsg_new_thread(array($recipient, $recipient2), $subject, $body1, array('author' => $author));
    privatemsg_reply($return['message']->thread_id, $body2, array('author' => $recipient));

    // Check with user without delete permission.
    $this->drupalLogin($recipient2);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText($subject, 'Subject is displayed');
    $this->assertText($body1, 'First message is displayed');
    $this->assertText($body2, 'Second message is displayed');
    $this->assertNoLink(t('Delete'), 'Delete message is link is not displayed for user without permission');

    // Check if access for that user is denied.
    $this->drupalGet('messages/delete/' . $return['message']->thread_id . '/' . $return['message']->mid);
    $this->assertText(t('Access denied'));

    // Check with user with delete access.
    $this->drupalLogin($recipient);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText(t('Delete'), 'Delete message is link is displayed for user without permission');

    // Click delete link of the second message and cancel.
    $this->clickLink(t('Delete'), 1);
    $this->assertText(t('Are you sure you want to delete this message?'), 'Confirmation message displayed');
    $this->clickLink(t('Cancel'));
    $this->assertText($body2, 'Second message is still displayed');

    // Confirm message deletion.
    $this->clickLink(t('Delete'), 1);
    $this->assertText(t('Are you sure you want to delete this message?'), 'Confirmation message displayed');
    $this->drupalPost(NULL, array(), t('Delete'));
    $this->assertText(t('Message has been deleted.'), 'Message has been deleted');
    $this->assertText($body1, 'First message is still displayed');
    $this->assertNoText($body2, 'Second message was deleted');

    // Click delete link of the first message and cancel.
    $this->clickLink(t('Delete'));
    $this->assertText(t('Are you sure you want to delete this message?'), 'Confirmation message displayed');
    $this->clickLink(t('Cancel'));
    $this->assertText($body1, 'First message is still displayed');

    // Confirm message deletion.
    $this->clickLink(t('Delete'));
    $this->assertText(t('Are you sure you want to delete this message?'), 'Confirmation message displayed');
    $this->drupalPost(NULL, array(), t('Delete'));
    $this->assertText(t('Message has been deleted.'), 'Message deleted has been deleted');
    $this->assertNoText($subject, 'All messages of that thread have been deleted');

    // Test if the message has not been deleted for other users.
    $this->drupalLogin($recipient2);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText($body1, 'First message is still displayed');
    $this->assertText($body2, 'First message is still displayed');

    // Test delete all checkbox.
    $this->drupalLogin($admin);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->clickLink(t('Delete'), 1);
    $this->drupalPost(NULL, array('delete_options' => TRUE), t('Delete'));
    $this->assertText(t('Message has been deleted for all users.'), 'Message deleted has been deleted');

    // Test if the message has been deleted for all users.
    $this->drupalLogin($recipient2);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText($body1, 'First message is still displayed');
    $this->assertNoText($body2, 'Second message has been deleted for all users');

    // Check that messages of canceled users (user_cancel_delete) are deleted too.
    $edit = array('body[value]' => $this->randomName(100));
    $this->drupalPost(NULL, $edit, t('Send message'));
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText($edit['body[value]'], t('New reply is displayed'));

    // Reload user object, don't use the cache.
    $recipient2 = user_load($recipient2->uid, TRUE);

    // Attempt to cancel account.
    variable_set('user_cancel_method', 'user_cancel_delete');
    $this->drupalGet('user/' . $recipient2->uid . '/edit');
    $this->drupalPost(NULL, NULL, t('Cancel account'));

    // Confirm account cancellation.
    // Explicitly use time(), REQUEST_TIME is not exact enough.
    $timestamp = time();
    $this->drupalPost(NULL, NULL, t('Cancel account'));

    // Confirm account cancellation request.
    $this->drupalGet("user/$recipient2->uid/cancel/confirm/$timestamp/" . user_pass_rehash($recipient2->pass, $timestamp, $recipient2->login));

    // Simpletest thinks that we are still logged in.
    $this->loggedInUser = NULL;

    $this->drupalLogin($admin);
    $this->drupalGet('messages/view/' . $return['message']->thread_id);
    $this->assertText($body1, 'First message is still displayed');
    $this->assertNoText($edit['body[value]'], t('Reply of deleted user is not displayed anymore'));

    // Test if admin is allowed to delete messages of other users.
    $this->drupalGet('user/' . $author->uid . '/messages');
    $this->checkThreadDelete($return['message']);

    // Check if user is allowed to delete messages.
    $this->drupalLogin($author);
    $this->drupalGet('messages');
    $this->checkThreadDelete($return['message']);

    // Check that deleting users that didn't send any message does not cause
    // errors.
    $this->drupalLogin($dummy);

    // Reload user object, don't use the cache.
    $dummy = user_load($dummy->uid, TRUE);

    // Attempt to cancel account.
    $this->drupalGet('user/' . $dummy->uid . '/edit');
    $this->drupalPost(NULL, NULL, t('Cancel account'));

    // Confirm account cancellation.
    // Explicitly use time(), REQUEST_TIME is not exact enough.
    $timestamp = time();
    $this->drupalPost(NULL, NULL, t('Cancel account'));

    // Confirm account cancellation request.
    $this->drupalGet("user/$dummy->uid/cancel/confirm/$timestamp/" . user_pass_rehash($dummy->pass, $timestamp, $dummy->login));
  }

  function checkThreadDelete($message) {
    $this->assertText($message->subject, t('Message is displayed.'));

    $delete = array(
      'list[' . $message->thread_id . ']' => 1,
    );
    $this->drupalPost(NULL, $delete, t('Delete'));
    $this->assertText(t('Deleted @count thread.', array('@count' => 1)), t('Delete message displayed.'));
    $this->assertNoText($message->subject, t('Message is not displayed anymore.'));
    $this->assertText(t('No messages available.'), t('No messages available anymore.'));

    // Revert delete action.
    $this->clickLink(t('undone'));

    $this->assertText(t('Restored @count thread.', array('@count' => 1)), t('Restore message displayed'));
    $this->assertText($message->subject, t('Message is displayed again.'));
    $this->assertNoText(t('No messages available.'), t('Messages are available.'));
  }

  /**
   * Test preview functionality.
   */
  function testPreview() {
    $user = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));

    // Enable preview button.
    variable_set('privatemsg_display_preview_button', TRUE);

    $message = array(
      'recipient' => $user->name,
      'subject' => $this->randomName(),
      'body[value]' => $this->randomName(50),
    );
    $this->drupalLogin($user);

    // Preview message.
    $this->drupalPost('messages/new', $message, t('Preview message'));
    $this->assertTitle(t('Write new message to @user', array('@user' => $user->name)) . ' | Drupal', t('Correct title is displayed.'));
    $this->assertFieldByXPath($this->buildXPathQuery('//div[@class=:class]/p', array(':class' => 'privatemsg-message-body')), $message['body[value]'], t('Message body is previewed'));
    $this->assertFieldByName('body[value]', $message['body[value]'], t('Message body field has the correct default value.'));

    // Send message.
    $this->drupalPost(NULL, array(), t('Send message'));
    $this->assertText($message['subject'], t('Message subject is displayed.'));
    $this->assertText($message['body[value]'], t('Message body is displayed.'));

    $this->assertText(t('A message has been sent to @recipient.', array('@recipient' => $user->name)), t('Sent confirmation displayed.'));

  }

  /**
   * Test autocomplete.
   */
  function testAutocomplete() {
    $current = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $user1 = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $user2 = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $user3 = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));

    $this->drupalLogin($current);

    // Use specific names to be able to test for specific name combinations.
    user_save($current, array('name' => 'wathever'));
    user_save($user1, array('name' => 'aaaa'));
    user_save($user2, array('name' => 'aaab'));
    user_save($user3, array('name' => 'bbbb'));

    $json = $this->drupalGet('messages/autocomplete/aa');
    $autocomplete = (array)json_decode($json);
    $this->assertEqual(count($autocomplete), 2, t('Autocomplete object contains two suggestions.'));
    $this->assertEqual($autocomplete['aaaa, '], 'aaaa');
    $this->assertEqual($autocomplete['aaab, '], 'aaab');

    $json = $this->drupalGet('messages/autocomplete/bb');
    $autocomplete = (array)json_decode($json);
    $this->assertEqual(count($autocomplete), 1, t('Autocomplete object contains one suggestion.'));
    $this->assertEqual($autocomplete['bbbb, '], 'bbbb');

    $json = $this->drupalGet('messages/autocomplete/cc');
    $autocomplete = (array)json_decode($json);
    $this->assertEqual(count($autocomplete), 0, t('Autocomplete object contains no suggestions.'));

    $json = $this->drupalGet('messages/autocomplete/aaaa, a');
    $autocomplete = (array)json_decode($json);
    $this->assertEqual(count($autocomplete), 1, t('Autocomplete object contains one suggestion.'));
    $this->assertEqual($autocomplete['aaaa, aaab, '], 'aaab');

    // Test XSS protection, create a username and check that the suggestion is
    // safe.
    $user4 = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $user4 = user_save($user4, array('name' => "<script>alert('XSS')</script>"));

    $json = $this->drupalGet('messages/autocomplete/<sc');
    $autocomplete = (array)json_decode($json);
    $this->assertEqual(count($autocomplete), 1, t('Autocomplete object contains one suggestion.'));
    $this->assertEqual($autocomplete[strip_tags($user4->name) . ', '], strip_tags($user4->name));
  }

  /**
   * Implements tearDown().
   */
  function tearDown() {
    //we dont really need to do this. i'm adding it just to keep it in front of my eyes so i can memorize it.
    parent::tearDown();
  }
}

/**
 * Tests for fields integration.
 */
class PrivatemsgFieldsTestCase extends PrivatemsgBaseTestCase {
  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array
    (
      'name' => t('Privatemsg fields.'),
      'description' => t('Tests integration with fields.'),
      'group' => t('Privatemsg'),
    );
  }

  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('privatemsg', 'image', 'text', 'field_ui');
  }

  function testSingleField() {
    $admin = $this->drupalCreateUser(array('administer privatemsg settings', 'write privatemsg', 'read privatemsg'));
    $user = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));

    $this->drupalLogin($admin);

    // Create a new field.
    $edit = array(
      'fields[_add_new_field][label]' => $label = $this->randomName(),
      'fields[_add_new_field][field_name]' => $name = strtolower($this->randomName()),
      'fields[_add_new_field][type]' => 'text',
      'fields[_add_new_field][widget_type]' => 'text_textfield',
    );
    $this->drupalPost('admin/config/messaging/privatemsg/fields', $edit, t('Save'));
    $this->drupalPost(NULL, array(), t('Save field settings'));
    $this->drupalPost(NULL, array(), t('Save settings'));

    // Enable preview button.
    variable_set('privatemsg_display_preview_button', TRUE);

    // Preview message.
    $message = array(
      'recipient' => $user->name,
      'subject' => $this->randomName(),
      'body[value]'    => $this->randomName(50),
      'field_' . $name . '[und][0][value]' => $this->randomName(50),
    );
    $this->drupalPost('messages/new', $message, t('Preview message'));

    // Send message.
    $this->drupalPost(NULL, array(), t('Send message'));

    // Check message.
    $this->drupalLogin($user);
    $this->drupalGet('messages');
    $this->clickLink($message['subject']);

    $this->assertText($message['body[value]'], t('Message body displayed.'));
    $this->assertText($message['field_' . $name . '[und][0][value]'], t('Content of new field is displayed.'));

    // Respond.
    $response = array(
      'body[value]' => $this->randomName(50),
      'field_' . $name . '[und][0][value]' => $this->randomName(50),
    );
    $this->drupalPost(NULL, $response, t('Send message'));

    // Check response.
    $this->drupalLogin($admin);
    $this->drupalGet('messages');
    $this->clickLink($message['subject']);

    $this->assertText($response['body[value]'], t('Message body displayed.'));
    $this->assertText($response['field_' . $name . '[und][0][value]'], t('Content of new field is displayed.'));
  }

  /**
   * Verify that a message with an empty image can be sent.
   */
  function testEmptyImage() {
    $admin = $this->drupalCreateUser(array('administer privatemsg settings', 'write privatemsg', 'read privatemsg'));
    $user = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));

    $this->drupalLogin($admin);

    // Create a new field.
    $edit = array(
      'fields[_add_new_field][label]' => $label = $this->randomName(),
      'fields[_add_new_field][field_name]' => $name = strtolower($this->randomName()),
      'fields[_add_new_field][type]' => 'image',
      'fields[_add_new_field][widget_type]' => 'image_image',
    );
    $this->drupalPost('admin/config/messaging/privatemsg/fields', $edit, t('Save'));
    $this->drupalPost(NULL, array(), t('Save field settings'));
    $this->drupalPost(NULL, array(), t('Save settings'));

    // Enable preview button.
    variable_set('privatemsg_display_preview_button', TRUE);

    // Preview message.
    $message = array(
      'recipient' => $user->name,
      'subject' => $this->randomName(),
      'body[value]'    => $this->randomName(50),
    );
    $this->drupalPost('messages/new', $message, t('Preview message'));

    // Send message.
    $this->drupalPost(NULL, array(), t('Send message'));

    // Check message.
    $this->drupalLogin($user);
    $this->drupalGet('messages');
    $this->clickLink($message['subject']);

    $this->assertText($message['body[value]'], t('Message body displayed.'));
  }
}

/**
 * Tests for fields integration.
 */
class PrivatemsgLinksTestCase extends PrivatemsgBaseTestCase {

  /**
   * Use testing profile.
   */
  protected $profile = 'standard';

  /**
   * Implements of getInfo().
   */
  public static function getInfo() {
    return array
    (
      'name' => t('Privatemsg links'),
      'description' => t('Tests links displayed in nodes, profiles and blocks.'),
      'group' => t('Privatemsg'),
    );
  }

  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('privatemsg');
  }

  /**
   * Tests author links displayed on nodes and comments.
   */
  function testAuthorLinks() {
    $admin = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg', 'administer privatemsg settings', 'create article content', 'create page content'));
    $user = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));

    $this->drupalLogin($admin);

    $settings = array(
      'privatemsg_display_link_self' => FALSE,
      'privatemsg_link_node_types[article]' => TRUE,
      'privatemsg_display_on_teaser' => FALSE,
      'privatemsg_display_on_comments' => TRUE,
    );
    $this->drupalPost('admin/config/messaging/privatemsg', $settings, t('Save configuration'));

    $node1 = array(
      'title' => $this->randomName(10),
      'body[und][0][value]' => $this->randomString(50),
    );
    $this->drupalPost('node/add/article', $node1, t('Save'));

    $comment = array(
      'comment_body[und][0][value]' => $this->randomName(20),
    );
    $this->drupalPost(NULL, $comment, t('Save'));

    $node2 = array(
      'title' => $this->randomName(),
      'body[und][0][value]' => $this->randomString(50),
    );
    $this->drupalPost('node/add/page', $node2, t('Save'));

    $this->drupalGet('node');
    $this->assertNoText(t('Send author a message'), t('Send author a message link not displayed.'));
    $this->clickLink($node1['title']);
    $this->assertNoText(t('Send author a message'), t('Send author a message link not displayed.'));

    $this->drupalLogin($user);
    $this->drupalGet('node');
    $this->assertNoText(t('Send author a message'), t('Send author a message link not displayed.'));
    $this->clickLink($node1['title']);
    $this->assertNoUniqueText(t('Send author a message'), t('Send author a message link displayed.'));

    $this->clickLink(t('Send author a message'));
    // To field and subject should be correctly pre-filled now.
    $this->drupalPost(NULL, array(), t('Send message'));

    // Make sure the message was sent to the correct user.
    $this->assertText(t('A message has been sent to @user', array('@user' => $admin->name)));

    // @todo: Do not guess nid.
    $this->drupalGet('node/2');
    $this->assertNoText(t('Send author a message'), t('Send author a message link not displayed.'));

    $this->drupalLogin($admin);
    $this->drupalGet('messages');
    $this->assertText(t('Message regarding @node', array('@node' => $node1['title'])));
  }

  /**
   * Tests menu block.
   */
  function testMenuBlock() {
    $admin = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg', 'administer privatemsg settings', 'administer blocks', 'administer menu'));
    $user = $this->drupalCreateUser(array('read privatemsg'));

    // Enable block.
    $this->drupalLogin($admin);
    $blocks = array(
      'blocks[privatemsg_privatemsg-menu][region]' => 'sidebar_second',
    );
    $this->drupalPost('admin/structure/block', $blocks, t('Save blocks'));

    // Disable secondary menu.
    /* @todo: Not yet possible because simpletest needs a log out link to verify that the user is logged in.
    $menu_settings = array(
      'menu_secondary_links_source' => '',
    );
    $this->drupalPost('admin/structure/menu/settings', $menu_settings, t('Save configuration'));
     *
     */

    $this->drupalGet('');
    $this->assertText(t('Private messages'), t('Privatemsg menu block title displayed.'));
    $this->assertText('Write new message', t('Write new message link displayed.'));

    $message = array(
      'recipient' => $user->name,
      'subject' => $this->randomName(),
      'body[value]' => $this->randomName(50),
    );
    $this->drupalPost('messages/new', $message, t('Send message'));

    $this->drupalLogin($user);
    $this->assertNoText(t('Write new message'), t('Write new message link not displayed.'));
    $this->assertNoUniqueText(t('Messages (1 new)'), t('Messages link including new message information displayed'));
  }

  /**
   * Tests menu block.
   */
  function testNewBlock() {
    $admin = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg', 'administer privatemsg settings', 'administer blocks', 'administer menu'));
    $user = $this->drupalCreateUser(array('read privatemsg'));

    // Enable block.
    $this->drupalLogin($admin);
    $blocks = array(
      'blocks[privatemsg_privatemsg-new][region]' => 'sidebar_second',
    );
    $this->drupalPost('admin/structure/block', $blocks, t('Save blocks'));

    $this->drupalGet('');
    $this->assertNoText(t('New message'), t('Privatemsg new block title not displayed.'));

    $message = array(
      'recipient' => $user->name,
      'subject' => $this->randomName(),
      'body[value]' => $this->randomName(50),
    );
    $this->drupalPost('messages/new', $message, t('Send message'));

    $this->drupalLogin($user);
    $this->assertText(t('New message'), t('Privatemsg new block title displayed.'));

    $this->assertText(t('You have a new message! Click here to read it.'), t('New message indication displayed.'));
  }
}

/**
 * Tests for fields integration.
 */
class PrivatemsgTokenTestCase extends PrivatemsgBaseTestCase {
  /**
   * Implements of getInfo().
   */
  public static function getInfo() {
    return array
    (
      'name' => t('Privatemsg tokens'),
      'description' => t('Tests tokens in private messages.'),
      'group' => t('Privatemsg'),
      'dependencies' => array('token'),
    );
  }

  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('privatemsg', 'token');
  }

  /**
   * Basic token functionality.
   */
  function testBasicTokens() {
    $author = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg', 'use tokens in privatemsg'));
    $recipient1 = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient2 = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));

    $this->drupalLogin($author);

    // Enable preview button.
    variable_set('privatemsg_display_preview_button', TRUE);

    // Create message with tokens and preview it.
    $edit = array(
      'recipient'   => $recipient1->name . ', ' . $recipient2->name,
      'subject'     => 'Hey [privatemsg_message:recipient:name]',
      'body[value]' => "Testing a few tokens.\n\nSubject: [privatemsg_message:subject]\n\nAuthor: [privatemsg_message:author:name]\n\nInvalid token: [privatemsg_message:invalid_token]",
    );
    $this->drupalPost('messages/new', $edit, t('Preview message'));

    // Make sure the tokens in subject and body are correctly displayed in the
    // preview.
    $this->assertText('Hey &lt; Token [privatemsg_message:recipient:name] &gt;', t('Token is displayed in subject.'));
    $this->assertText('Subject: &lt; Token [privatemsg_message:subject] &gt;', t('Subject token is displayed.'));
    $this->assertText('Author: &lt; Token [privatemsg_message:author:name] &gt;', t('Author token is displayed.'));
    $this->assertText('Invalid token: &lt; INVALID TOKEN [privatemsg_message:invalid_token] &gt;', t('Invalid token is displayed.'));
    $this->assertText(t('Note: Valid tokens will be replaced when a recipient is reading this message.'), t('Token notice is displayed.'));

    $this->drupalPost(NULL, array(), t('Send message'));

    // Make sure the tokens in subject and body are correctly displayed in the
    // sent message.
    $this->assertText('Hey &lt; Token [privatemsg_message:recipient:name] &gt;', t('Token is displayed in subject.'));
    $this->assertText('Subject: &lt; Token [privatemsg_message:subject] &gt;', t('Subject token is displayed.'));
    $this->assertText('Author: &lt; Token [privatemsg_message:author:name] &gt;', t('Author token is displayed.'));
    $this->assertText('Invalid token: &lt; INVALID TOKEN [privatemsg_message:invalid_token] &gt;', t('Invalid token is displayed.'));
    $this->assertText(t('Note: Valid tokens will be replaced when a recipient is reading this message.'), t('Token notice is displayed.'));

    // Log in as the first recipient, verify that he sees the message with the
    // replacements.
    $this->drupalLogin($recipient1);
    $this->drupalGet('messages');
    $this->clickLink('Hey ' . $recipient1->name);

    // Make sure the tokens in subject and body are correctly displayed in the
    // message.
    $this->assertText('Hey ' . $recipient1->name, t('Replaced token is displayed in subject.'));
    $this->assertText('Subject: Hey ' . $recipient1->name, t('Subject token is replaced.'));
    $this->assertText('Author: ' . $author->name, t('Author token is replaced.'));
    $this->assertText('Invalid token: [privatemsg_message:invalid_token]', t('Invalid token is displayed.'));
    $this->assertNoText(t('Note: Valid tokens will be replaced when a recipient is reading this message.'), t('Token notice is displayed.'));

    // Reply, verify that the message still shows the correct subject and
    // tokens from this user are not replaced.
    $reply = array(
      'body[value]' => 'Response with a token [privatemsg_message:mid]',
    );
    $this->drupalPost(NULL, $reply, t('Send message'));

    $this->drupalLogin($recipient2);
    $this->drupalGet('messages');
    $this->clickLink('Hey ' . $recipient2->name);

    // Make sure the tokens in subject and body are correctly displayed in the
    // message.
    $this->assertText('Hey ' . $recipient2->name, t('Replaced token is displayed in subject.'));
    $this->assertText('Subject: Hey ' . $recipient2->name, t('Subject token is replaced.'));
    $this->assertText('Author: ' . $author->name, t('Author token is replaced.'));
    $this->assertText('Invalid token: [privatemsg_message:invalid_token]', t('Invalid token is displayed.'));
    $this->assertText('Response with a token [privatemsg_message:mid]', t('Token from recipient is not replaced.'));
    $this->assertNoText(t('Note: Valid tokens will be replaced when a recipient is reading this message.'), t('Token notice is displayed.'));

    $this->drupalLogin($author);
    $this->drupalGet('messages');

    // Assert that token is displayed in the subject for the author.
    $this->assertText('Hey &lt; Token [privatemsg_message:recipient:name] &gt;', t('Token is displayed correctly in subject for author.'));
  }
}

/**
 * Privatemsg API tests
 */
class PrivatemsgAPITestCase extends PrivatemsgBaseTestCase {
  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      // 'name' should start with what is being tested (menu item) followed by what about it
      // is being tested (creation/deletion).
      'name' => t('Privatemsg API functionality.'),
      // 'description' should be one or more complete sentences that provide more details on what
      // exactly is being tested.
      'description' => t('Test sending, receiving, listing, deleting messages and other features via API.'),
      // 'group' should be a logical grouping of test cases, like a category.  In most cases, that
      // is the module the test case is for.
      'group' => t('Privatemsg'),
    );
  }

  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('privatemsg');

    // Create the full html format.
    $full_html_format = array(
      'format' => 'full_html',
      'name' => 'Full HTML',
      'weight' => 1,
      'filters' => array(
        // URL filter.
        'filter_url' => array(
          'weight' => 0,
          'status' => 1,
        ),
        // Line break filter.
        'filter_autop' => array(
          'weight' => 1,
          'status' => 1,
        ),
        // HTML corrector filter.
        'filter_htmlcorrector' => array(
          'weight' => 10,
          'status' => 1,
        ),
      ),
    );
    $full_html_format = (object) $full_html_format;
    filter_format_save($full_html_format);
    // Refresh permissions.
    $this->checkPermissions(array(), TRUE);
  }

  function testPrivatemsgApiNewThread() {
    $author     = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient1  = $this->drupalCreateUser(array('read privatemsg'));
    $recipient2  = $this->drupalCreateUser(array('read privatemsg'));
    $recipient3  = $this->drupalCreateUser(array('read privatemsg'));

    // Reset user_access cache
    user_access('', $author, TRUE);

    $resultok1 = privatemsg_new_thread(array($recipient1, $recipient2, $recipient3), 'normal message', 'Body text', array('author' => $author));
    $this->assertTrue($resultok1['success'], 'Private message could be sent successfully');

    $message = $this->getMessageFromSubject('normal message');
    $this->assertFalse(empty($message), 'Message was saved in database');
    $this->assertEqual($message->author, $author->uid, 'Message was sent by author');

    $resultok2 = privatemsg_new_thread(array($recipient1, $recipient2, $recipient3), 'empty body', '', array('author' => $author));
    $this->assertTrue($resultok2['success'], 'API allowed to send message without body');

    $resultf1 = privatemsg_new_thread(array($recipient1, $recipient2, $recipient3), '', 'No subject', array('author' => $author));
    $this->assertEqual('A subject must be included with the message.', $resultf1['messages']['error'][0], 'API denied to send message without a subject');

    $resultf2 = privatemsg_new_thread(array(), 'no recipients', 'Body text', array('author' => $author));
    $this->assertEqual('At least one valid recipient must be included with the message.', $resultf2['messages']['error'][0], 'API denied to send message without recipients');
    $message = $this->getMessageFromSubject('no recipients');
    $this->assertTrue(empty($message), 'Message was not saved in database');

    $resultf3 = privatemsg_new_thread(array($recipient1, $recipient2, $recipient3), 'not allowed', 'Body text', array('author' => $recipient1));
    $errormessage = t('@user is not allowed to write messages.', array('@user' => $recipient1->name));
    $this->assertEqual($errormessage, $resultf3['messages']['error'][0], 'API denied to send message from user without permission');
    $message = $this->getMessageFromSubject('not allowed');
    $this->assertTrue(empty($message), 'Message was not saved in database');

    // Test with an input format that the author is not allowed to use.
    $resultf4 = privatemsg_new_thread(array($recipient1, $recipient2, $recipient3), 'input filter not allowed', 'Body text', array('author' => $author, 'format' => 'full_html'));
    $errormessage = t('@user is not allowed to use the specified input format.', array('@user' => $author->name));
    $this->assertEqual($errormessage, $resultf4['messages']['error'][0], t('User is not allowed to use the specified input format.'));
    $message = $this->getMessageFromSubject('input filter not allowed');
    $this->assertTrue(empty($message), 'Message was not saved in database');

    // Send a message through the api to the same user and check if it marked
    // as new.
    privatemsg_new_thread(array($author), $subject = $this->randomName(10), $this->randomString(20), array('author' => $author));
    $this->drupalLogin($author);
    $this->drupalGet('messages');
    $this->clickLink($subject);
    $this->assertText(t('New'), t('Message is marked as new'));
  }

  function getMessageFromSubject($subject) {
    return db_query("SELECT * FROM {pm_message} WHERE subject = :subject", array(':subject' => $subject))->fetchObject();
  }

  function testPrivatemsgApiReply() {
    $author     = $this->drupalCreateUser(array('write privatemsg'));
    $recipient1  = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $recipient2  = $this->drupalCreateUser(array('read privatemsg', 'write privatemsg'));
    $recipient3  = $this->drupalCreateUser(array('read privatemsg'));

    // Reset user_access cache
    user_access('', $author, TRUE);

    $resultok = privatemsg_new_thread(array($recipient2, $recipient1, $recipient3), 'test reply', 'body text', array('author' => $author));
    $this->assertTrue($resultok['success'], 'Private message could be sent successfully');

    $thread_row = $this->getMessageFromSubject('test reply');

    $resultok = privatemsg_reply($thread_row->mid, 'Test Body', array('author' => $author));
    $this->assertTrue($resultok['success'], 'Reply could be sent successfully');

    $resultok = privatemsg_reply($thread_row->mid, 'Test Body', array('author' => $recipient1));
    $this->assertTrue($resultok['success'], 'Reply could be sent successfully');

    $resultf1 = privatemsg_reply($thread_row->mid, '', array('author' => $recipient2));
    $this->assertFalse($resultf1['success'], 'API denied to send message without body.');
    $this->assertEqual($resultf1['messages']['error'][0], t('A message must be included in your reply.'), 'Correct error returned when replying with an empty body.');

    $resultf2 = privatemsg_reply($thread_row->mid, 'Test Body', array('author' => $recipient3));
    $errormessage = t('@user is not allowed to write messages.', array('@user' => $recipient3->name));
    $this->assertEqual($errormessage, $resultf2['messages']['error'][0], 'API denied to send message from user without permission');

  }

  /**
   * Test various use cases for privatemsg_get_link().
   */
  function testGetLink() {
    $author      = $this->drupalCreateUser(array('write privatemsg', 'read privatemsg'));
    $recipient1  = $this->drupalCreateUser(array('read privatemsg'));
    $recipient2  = $this->drupalCreateUser(array('read privatemsg'));
    $recipient3  = $this->drupalCreateUser(array('read privatemsg', 'allow disabling privatemsg'));
    $recipient4  = $this->drupalCreateUser();

    $this->drupalLogin($author);

    $this->drupalGet(privatemsg_get_link(array($recipient1)));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user]');

    $this->drupalGet(privatemsg_get_link(array($recipient1, $recipient2)));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user], ' . $recipient2->name . ' [user]');

    $this->drupalGet(privatemsg_get_link(array($recipient1, $recipient2), $author));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user], ' . $recipient2->name . ' [user]');

    $this->drupalGet(privatemsg_get_link(array($recipient1, $recipient2), $author, $subject = 'Str/"ang\\w3//'));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user], ' . $recipient2->name . ' [user]');
    $this->assertFieldByName('subject', $subject);

    // Disable privatemsg for recipient 3.
    db_insert('pm_disable')
      ->fields(array(
        'uid' => $recipient3->uid,
      ))
      ->execute();
    $this->assertFalse(privatemsg_get_link(array($recipient3), $author));

    $this->drupalGet(privatemsg_get_link(array($recipient1, $recipient3), $author));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user]');

    // Disable links to self, verify that a link is only returned when the
    // author is not the only recipient.
    variable_set('privatemsg_display_link_self', FALSE);

    $this->assertFalse(privatemsg_get_link(array($author), $author));

    $this->drupalGet(privatemsg_get_link(array($recipient1, $author), $author));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user]');

    // Verify that link is not shown when recipient doesn't have read
    // permission.
    $this->assertFalse(privatemsg_get_link(array($recipient4), $author));

    $this->drupalGet(privatemsg_get_link(array($recipient1, $recipient4), $author));
    $this->assertFieldByName('recipient', $recipient1->name . ' [user]');

    // Verify that link is not shown when author does not have write permission.
    $this->drupalLogin($recipient1);
    $this->assertFalse(privatemsg_get_link(array($author), $recipient1));
  }
}
